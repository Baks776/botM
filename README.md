## Телеграм-бот: рассылка по расписанию из Google Sheets

### Что делает
- Читает строки из Google Sheets и планирует отправку сообщений в чаты/группы.
- Поддерживает текст и медиа (photo/video/document) с подписью.
- Расписание по времени дня, дню недели, дню месяца. Таймзона — Europe/Moscow.
- Автообновление расписания из таблицы каждые `REFRESH_MINUTES`.

### Настройка окружения
1) Установить Python 3.11+.  
2) Создать и активировать venv.  
3) `pip install -r requirements.txt`  
4) Подготовить сервисный аккаунт Google:
   - Включить Google Sheets API.
   - Создать сервисный аккаунт и JSON-ключ, сохранить рядом как `service_account.json` (или укажи путь в `GOOGLE_SERVICE_ACCOUNT_JSON`).
   - Выдать аккаунту доступ на чтение таблицы (share по email из JSON).
5) Заполнить переменные окружения (можно через `.env` или export):
   - `TELEGRAM_BOT_TOKEN` — токен бота.
   - `GOOGLE_SHEET_ID` — ID таблицы.
   - `GOOGLE_SHEET_WORKSHEET` — имя листа (опционально, по умолчанию Sheet1).
   - `GOOGLE_SERVICE_ACCOUNT_JSON` — путь к ключу (опционально).
   - `REFRESH_MINUTES` — период обновления расписания (по умолчанию 5).
   - `TZ` — таймзона, по умолчанию `Europe/Moscow`.
   - `DEFAULT_PARSE_MODE` — `HTML` или `Markdown`.

Запуск:  
`python main.py`

### Формат таблицы
Первая строка — заголовки. Обязательные столбцы: `chat_id`, `message`, `time`. Остальные — опциональны. Можно писать заголовки по‑русски или по‑английски — бот понимает синонимы:
- `вкл`, `активно`, `enabled`
- `чат`, `чат id`, `chat_id`
- `сообщение`, `message`
- `время`, `time`
- `дни`, `день недели`, `weekday`
- `число`, `дата`, `monthday`
- `тип медиа`, `media`, `media_type`
- `ссылка медиа`, `файл`, `media_url`
- `формат`, `parse_mode`

Пример (можно смешивать языки в заголовках):

| чат id | сообщение | время | дни | число | тип медиа | ссылка медиа | формат | вкл |
|--------|-----------|-------|-----|-------|-----------|--------------|--------|-----|
| -100123| Привет!   | 09:00 | пн,ср|      | photo     | https://...  | HTML   | yes |
| -100456| Текст     | 21:30 |     | 15    |           |              | Markdown| 1  |

Правила:
- `time` — `HH:MM` (24h).
- `weekday` — опционально, перечисление через запятую/`;` (пн, вт, ср, чт, пт, сб, вс или mon..sun).
- `monthday` — опционально, число 1–31.
- Если указаны и `weekday`, и `monthday`, сработает, когда совпадут оба условия.
- `enabled` — активна строка, допускаются значения: `1/true/yes/y/да`.
- `media_type` — `photo` | `video` | `document`; `media_url` обязателен при наличии `media_type`.
- В ячейку нужно вставлять ссылку или `file_id` Telegram. Вставка самой картинки в ячейку (Insert image) не читается и не отправится.
- `parse_mode` — `HTML` или `Markdown`; по умолчанию значение из окружения.

### Как узнать chat_id группы через бота
- Добавь бота в группу.
- Дай ему право читать сообщения.
- Отправь в группе команду `/chat_id`.
- Бот ответит сообщением с числовым `chat_id` вида `-100...`.

### Как это работает внутри
- `apscheduler` создает cron-задачи для каждой строки. Идентификатор задачи формируется из строки таблицы, чтобы не плодить дубликаты.
- Каждые `REFRESH_MINUTES` задачи синхронизируются с таблицей: новые добавляются, удаленные снимаются.
- Отправка с ретраями (до 3 попыток) и логированием.

### Проверка
- После запуска смотри логи — появятся строки о созданных задачах.
- Для быстрой проверки добавь строку с ближайшим временем (через 2–3 минуты) и активируй `enabled`.

### Что важно
- Бот должен быть добавлен и иметь право писать в целевые группы.
- Храни ключ сервисного аккаунта вне репозитория.
- При большом числе сообщений помни про лимиты Telegram; здесь предусмотрен базовый ретрай.

